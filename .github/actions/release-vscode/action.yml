name: 'Release VSCode Extension'
description: 'Builds and publishes VSCode extension to VS Code Marketplace and Open VSX'

inputs:
  azure-pat:
    description: 'Azure DevOps Personal Access Token for VS Code Marketplace'
    required: true
  open-vsx-pat:
    description: 'Personal Access Token for Open VSX Registry'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Build extension
      shell: bash
      run: pnpm run build
      env:
        CI: true

    - name: Get version
      id: version
      shell: bash
      run: |
        VERSION=$(node -p "require('./package.json').version")
        TAG="v$VERSION"
        echo "current=$VERSION" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ Version: $VERSION"
        echo "ğŸ“¦ Tag: $TAG"
        echo "ğŸ“¦ Commit: ${{ github.sha }}"
        echo "ğŸ“¦ Ref: ${{ github.ref }}"

    - name: Publish to Open VSX Registry
      id: publishToOpenVSX
      uses: HaaLeo/publish-vscode-extension@v2
      with:
        pat: ${{ inputs.open-vsx-pat }}
        packagePath: .
        dependencies: false
        skipDuplicate: true

    - name: Publish to VS Code Marketplace
      uses: HaaLeo/publish-vscode-extension@v2
      with:
        pat: ${{ inputs.azure-pat }}
        registryUrl: https://marketplace.visualstudio.com
        extensionFile: ${{ steps.publishToOpenVSX.outputs.vsixPath }}
        dependencies: false
        skipDuplicate: true

    - name: Create and push tag
      shell: bash
      run: |
        TAG="v${{ steps.version.outputs.current }}"
        echo "ğŸ·ï¸ Checking tag: $TAG"
        echo "ğŸ·ï¸ Remote tags:"
        git ls-remote --tags origin | grep "$TAG" || echo "  (none matching)"
        if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
          echo "ğŸ·ï¸ Tag $TAG already exists, skipping"
        else
          echo "ğŸ·ï¸ Creating tag $TAG"
          git tag "$TAG"
          echo "ğŸ·ï¸ Pushing tag $TAG"
          git push origin "$TAG"
          echo "ğŸ·ï¸ Tag $TAG pushed successfully"
        fi

    - name: Summary
      shell: bash
      run: |
        TAG="v${{ steps.version.outputs.current }}"
        if git ls-remote --tags origin | grep -q "refs/tags/$TAG$"; then
          echo "âœ… Extension v${{ steps.version.outputs.current }} - tag exists"
        else
          echo "âœ… Extension v${{ steps.version.outputs.current }} published and tagged"
        fi
